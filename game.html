<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Game Screen - Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .bg-primary-dark { background-color: #121212; }
        .bg-secondary-dark { background-color: #1E1E1E; }
        .bg-accent-gold { background-color: #F9A825; }
        .text-gold { color: #F9A825; }
        .text-light { color: #E0E0E0; }
        .text-white-full { color: #FFFFFF; }
        .mobile-screen {
            max-width: 414px;
            height: 800px;
            border: 16px solid #1E1E1E;
            border-radius: 36px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .number-board-cell {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .number-board-cell.called {
            background-color: #F9A825;
            color: black;
            font-weight: 700;
        }
        .ticket {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #444;
        }
        .ticket-hot {
            border-color: #F9A825;
            box-shadow: 0 0 15px rgba(249, 168, 37, 0.5);
        }
        .ticket-number {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 4px;
        }
        .ticket-number.dabbed {
            background-color: #F9A825;
            color: black;
        }
        .ticket-number.empty {
            background-color: #1E1E1E;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center h-screen">
    <div class="mobile-screen bg-primary-dark text-white-full">
        <!-- Top Section: Number Display & Board -->
        <header class="p-4 bg-secondary-dark shadow-lg">
            <div class="flex items-center justify-between">
                <div class="text-center">
                    <div class="text-xs text-light">Current Number</div>
                    <div id="current-number-display" class="bg-accent-gold text-black text-4xl font-bold rounded-full w-20 h-20 flex items-center justify-center">
                        --
                    </div>
                </div>
                <!-- Number Board -->
                <div id="number-board" class="grid grid-cols-10 gap-1 text-xs">
                    <!-- Numbers 1-90 will be generated here by JavaScript -->
                </div>
            </div>
        </header>

        <!-- Main Content: Tickets Area -->
        <main class="flex-grow p-4 overflow-y-auto">
            <h2 class="text-gold font-bold mb-2">Your Tickets</h2>
            <div id="tickets-container" class="space-y-4">
                <!-- Tickets will be generated and rendered here by JavaScript -->
            </div>
        </main>

        <!-- Footer Area: Winners -->
        <footer class="p-2 bg-secondary-dark/80 backdrop-blur-sm border-t border-gray-700">
            <div class="bg-black bg-opacity-25 p-2 rounded-lg">
                <div class="text-gold text-sm font-bold">Winners</div>
                <div id="winners-list" class="text-light text-xs truncate">
                    <span>Waiting for winners...</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDz5rXqItBhZ1KcnP77brvJ47oZ0bUqYQU",
          authDomain: "tambola-gold.firebaseapp.com",
          projectId: "tambola-gold",
          storageBucket: "tambola-gold.appspot.com",
          messagingSenderId: "719738143899",
          appId: "1:719738143899:web:538dc685a0127a233a723e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- UI Element Selectors ---
        const numberBoard = document.getElementById('number-board');
        const currentNumberDisplay = document.getElementById('current-number-display');
        const ticketsContainer = document.getElementById('tickets-container');
        
        // --- UI Generation ---
        function createBoard() {
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.id = oard-num- + i;
                cell.className = 'number-board-cell';
                cell.innerText = i;
                numberBoard.appendChild(cell);
            }
        }
        
        // --- TICKET GENERATION LOGIC ---
        function generateTicketData() {
            let ticket = Array(3).fill(null).map(() => Array(9).fill(0));
            let ranges = [[1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]];
            let placed_in_col = Array(9).fill(0);

            for (let j = 0; j < 9; j++) {
                let nums_in_col = new Set();
                let count = (j === 0 || j === 8) ? (Math.random() > 0.3 ? 1 : 2) : (Math.random() > 0.5 ? 1 : 2);
                while (nums_in_col.size < count) {
                    nums_in_col.add(Math.floor(Math.random() * (ranges[j][1] - ranges[j][0] + 1)) + ranges[j][0]);
                }
                let sorted_nums = Array.from(nums_in_col).sort((a, b) => a - b);
                for (let num of sorted_nums) {
                    let row;
                    do {
                        row = Math.floor(Math.random() * 3);
                    } while (ticket[row][j] !== 0);
                    ticket[row][j] = num;
                    placed_in_col[j]++;
                }
            }

            for (let i = 0; i < 3; i++) {
                let nums_in_row = ticket[i].filter(n => n > 0).length;
                while (nums_in_row < 5) {
                    let col;
                    do {
                        col = Math.floor(Math.random() * 9);
                    } while (ticket[i][col] !== 0 || placed_in_col[col] >= 2);
                    
                    let num;
                    do {
                        num = Math.floor(Math.random() * (ranges[col][1] - ranges[col][0] + 1)) + ranges[col][0];
                    } while (ticket.flat().includes(num));
                    
                    ticket[i][col] = num;
                    placed_in_col[col]++;
                    nums_in_row++;
                }
            }
            return ticket;
        }

        function renderTicket(ticketData, isHot = false) {
            const ticketElement = document.createElement('div');
            ticketElement.className = isHot ? 'ticket ticket-hot' : 'ticket';
            
            let gridHtml = '<div class="grid grid-cols-9 gap-1">';
            for(let i=0; i<3; i++) {
                for(let j=0; j<9; j++) {
                    const number = ticketData[i][j];
                    if(number === 0) {
                        gridHtml += '<div class="ticket-number empty"></div>';
                    } else {
                        gridHtml += <div class="ticket-number" data-num=""></div>;
                    }
                }
            }
            gridHtml += '</div>';
            ticketElement.innerHTML = gridHtml;
            ticketsContainer.appendChild(ticketElement);
        }

        function updateUIWithCalledNumbers(calledNumbers) {
            document.querySelectorAll('.number-board-cell').forEach(cell => cell.classList.remove('called'));
            
            calledNumbers.forEach(num => {
                const boardCell = document.getElementById(oard-num-);
                if (boardCell) boardCell.classList.add('called');
                
                document.querySelectorAll(.ticket-number[data-num='']).forEach(ticketNum => {
                    ticketNum.classList.add('dabbed');
                });
            });
        }

        // --- CORRECTED INITIALIZATION ---
        window.onload = () => {
            createBoard();
            const ticket1 = generateTicketData();
            renderTicket(ticket1, true);
            const ticket2 = generateTicketData();
            renderTicket(ticket2);

            const gameRef = db.collection('games').doc('currentGame');
            gameRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const gameData = doc.data();
                    const calledNumbers = gameData.calledNumbers || [];
                    
                    if (calledNumbers.length > 0) {
                        currentNumberDisplay.innerText = calledNumbers[calledNumbers.length - 1];
                    } else {
                        currentNumberDisplay.innerText = '--';
                    }
                    updateUIWithCalledNumbers(calledNumbers);
                }
            });
        };
    </script>
</body>
</html>
