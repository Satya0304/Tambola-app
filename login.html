<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Login - Gold Theme</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .bg-primary-dark { background-color: #121212; }
        .bg-secondary-dark { background-color: #1E1E1E; }
        .bg-accent-gold { background-color: #F9A825; }
        .text-gold { color: #F9A825; }
        .border-gold { border-color: #F9A825; }
        .text-light { color: #E0E0E0; }
        .text-white-full { color: #FFFFFF; }
        .mobile-screen {
            max-width: 414px;
            height: 800px;
            border: 16px solid #1E1E1E;
            border-radius: 36px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center h-screen">
    <div class="mobile-screen bg-primary-dark flex flex-col text-white-full">
        <main class="flex-grow flex flex-col justify-center p-6 space-y-8">
            <h1 class="text-gold font-bold text-4xl text-center">TAMBOLA GOLD</h1>

            <!-- Phone input -->
            <div id="phone-view">
                <label for="phone" class="text-light text-sm font-semibold mb-2 block">Enter Mobile Number</label>
                <input type="tel" id="phone" name="phone"
                       class="w-full bg-secondary-dark rounded-lg p-3 border border-gray-700 focus:border-gold focus:outline-none"
                       placeholder="10-digit mobile number" maxlength="10"/>
                <div id="recaptcha-container" class="my-4"></div>
                <button id="send-otp-btn"
                        class="w-full bg-accent-gold text-black font-bold py-3 rounded-lg mt-4 shadow-lg">
                  Get OTP
                </button>
            </div>

            <!-- OTP input -->
            <div id="otp-view" class="hidden">
                <label for="otp" class="text-light text-sm font-semibold mb-2 block">Enter OTP</label>
                <input type="tel" id="otp" name="otp"
                       class="w-full bg-secondary-dark rounded-lg p-3 border border-gray-700 focus:border-gold focus:outline-none"
                       placeholder="6-digit OTP" maxlength="6"/>
                <button id="verify-otp-btn"
                        class="w-full bg-accent-gold text-black font-bold py-3 rounded-lg mt-4 shadow-lg">
                  Verify OTP
                </button>
            </div>
        </main>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyDz5rXqItBhZ1KcnP77brvJ47oZ0bUqYQU",
          authDomain: "tambola-gold.firebaseapp.com",
          projectId: "tambola-gold",
          storageBucket: "tambola-gold.appspot.com",
          messagingSenderId: "719738143899",
          appId: "1:719738143899:web:538dc685a0127a233a723e"
        };

        // Init Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const phoneView = document.getElementById('phone-view');
        const otpView = document.getElementById('otp-view');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const phoneInput = document.getElementById('phone');
        const otpInput = document.getElementById('otp');

        function isLocalhost() {
          return location.hostname === "localhost" || location.hostname.includes("127.0.0.1");
        }

        // reCAPTCHA setup
        window.onload = function() {
          if (!isLocalhost()) {
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
              size: 'invisible',
              callback: () => console.log("reCAPTCHA solved")
            });
            recaptchaVerifier.render();
          }
        };

        // Send OTP
        sendOtpBtn.addEventListener('click', () => {
          if (isLocalhost()) {
            // In dev mode, we simulate success and switch views
            alert("Dev mode: OTP verification is skipped. Enter '123456' to log in.");
            phoneView.classList.add('hidden');
            otpView.classList.remove('hidden');
            return;
          }

          const phoneNumber = "+91" + phoneInput.value;
          const appVerifier = window.recaptchaVerifier;

          auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then((confirmationResult) => {
              window.confirmationResult = confirmationResult;
              alert('OTP sent!');
              phoneView.classList.add('hidden');
              otpView.classList.remove('hidden');
            })
            .catch((error) => {
              console.error("Error sending OTP:", error);
              alert("Error sending OTP: " + error.message);
              window.recaptchaVerifier.render().then(widgetId => {
                grecaptcha.reset(widgetId);
              });
            });
        });

        // Verify OTP
        verifyOtpBtn.addEventListener('click', async () => {
          if (isLocalhost()) {
            // In dev mode, we create a fake user and log in
            if (otpInput.value === '123456') {
                await createUserProfile({
                    uid: "devUser911234567890", // Using a consistent dev UID
                    phoneNumber: "+911234567890"
                });
                alert("Dev mode: Logged in successfully!");
                window.location.href = 'home.html';
            } else {
                alert("Incorrect OTP for dev mode. Please use 123456.");
            }
            return;
          }

          const code = otpInput.value;
          window.confirmationResult.confirm(code)
            .then(async (result) => {
              const user = result.user;
              await createUserProfile(user);
              alert("Success! You are now logged in.");
              window.location.href = 'home.html';
            })
            .catch((error) => {
              console.error("Error verifying OTP:", error);
              alert("Incorrect OTP. Please try again.");
            });
        });

        // Create user profile if not exists
        async function createUserProfile(user) {
          const userRef = db.collection('users').doc(user.uid);
          const docSnap = await userRef.get();
          if (!docSnap.exists()) {
            await userRef.set({
              phoneNumber: user.phoneNumber,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              username: "Player" + user.uid.substring(0, 4),
              wallet: 0
            });
          }
        }
    </script>
</body>
</html>
